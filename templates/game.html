<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Snake Game</title>
  <style>
    body {
      text-align: center;
      font-family: 'Arial', sans-serif;
      background-color: #1e1e2e;
      color: #ffffff;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      cursor: default;
    }
    canvas {
      width: 600px;
      height: 450px;
      border: 3px solid black;
      background-color: #f0f0f0;
      display: none;
    }
    .button {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
      color: white;
      font-size: 20px;
      font-weight: bold;
      padding: 15px 40px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0px 5px 15px rgba(255, 69, 0, 0.4);
      outline: none;
      margin-top: 30px;
    }
    .button:hover {
      background: linear-gradient(45deg, #ff4b2b, #ff416c);
      transform: scale(1.05);
      box-shadow: 0px 7px 20px rgba(255, 69, 0, 0.6);
    }
    .button:active {
      transform: scale(0.95);
    }
    .hidden {
      display: none;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background-color: #2e2e2e;
      padding: 30px;
      border-radius: 10px;
      width: 350px;
      text-align: center;
    }
    .ranking-list {
      list-style: none;
      padding: 0;
      text-align: left;
      margin-top: 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>🐍 SNAKE GAME</h1>
  <h2>🏆 최고 점수: <span id="highScore">0</span></h2>
  <h3>🎯 현재 점수: <span id="currentScore">0</span></h3>
  <button id="startButton" class="button">🎮 게임 시작</button>
  <button id="restartButton" class="button hidden">🔄 재시작</button>
  <canvas id="gameCanvas" width="600" height="600"></canvas>

  <div id="gameOverScreen" class="hidden">
    <h1 style="color:red; font-size: 50px">GAME OVER</h1>
    <p id="usernameDisplay"></p>
    <p id="currentScoreDisplay"></p>
    <button id="restartGameOverButton" class="button">🔄 다시 시작</button>
  </div>

  <!-- 포탈방식 리애킹 목록 모델 -->
  <div id="rankingModal" class="modal hidden">
    <div class="modal-content">
      <h2>🏆 전체 랭킹 (Top 10)</h2>
      <ul id="rankingList" class="ranking-list"></ul>
      <button onclick="closeModal()" class="button">닫기</button>
    </div>
  </div>

  <script>
    const startButton = document.getElementById("startButton");
    const restartButton = document.getElementById("restartButton");
    const restartGameOverButton = document.getElementById("restartGameOverButton");
    const highScoreDisplay = document.getElementById("highScore");
    const currentScoreDisplay = document.getElementById("currentScore");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const box = 20;
    let snake, direction, food, score, gameInterval, gameRunning = false;

    document.addEventListener("DOMContentLoaded", function () {
      fetchHighScore();
    });

    function resetGame() {
      snake = [
        { x: 10 * box, y: 10 * box },
        { x: 9 * box, y: 10 * box },
        { x: 8 * box, y: 10 * box }
      ];
      direction = "RIGHT";
      food = { x: 0, y: 0 };
      score = 0;
      currentScoreDisplay.textContent = score;
      fetchFoodPosition();
    }

    function fetchHighScore() {
      fetch("/get_high_score")
        .then(res => res.json())
        .then(data => highScoreDisplay.textContent = data.high_score);
    }

    function fetchFoodPosition() {
      fetch("/game_data")
        .then(res => res.json())
        .then(data => food = data.food);
    }

    function startGame() {
      if (gameRunning) return;
      gameRunning = true;
      startButton.classList.add("hidden");
      restartButton.classList.add("hidden");
      gameOverScreen.classList.add("hidden");
      canvas.style.display = "block";
      resetGame();
      fetchHighScore();
      gameInterval = setInterval(drawGame, 100);
    }

    function restartGame() {
      clearInterval(gameInterval);
      startGame();
    }

    function changeDirection(e) {
      const key = e.key;
      if (key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
      else if (key === "ArrowUp" && direction !== "DOWN") direction = "UP";
      else if (key === "ArrowRight" && direction !== "LEFT") direction = "RIGHT";
      else if (key === "ArrowDown" && direction !== "UP") direction = "DOWN";
    }

    function drawGame() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "red";
      ctx.fillRect(food.x, food.y, box, box);

      ctx.fillStyle = "lime";
      snake.forEach(segment => ctx.fillRect(segment.x, segment.y, box, box));

      let newX = snake[0].x;
      let newY = snake[0].y;
      if (direction === "LEFT") newX -= box;
      if (direction === "RIGHT") newX += box;
      if (direction === "UP") newY -= box;
      if (direction === "DOWN") newY += box;

      if (newX === food.x && newY === food.y) {
        fetchFoodPosition();
        score += 10;
        currentScoreDisplay.textContent = score;
      } else {
        snake.pop();
      }

      const newHead = { x: newX, y: newY };

      if (
        newX < 0 || newX >= canvas.width ||
        newY < 0 || newY >= canvas.height ||
        snake.some(segment => segment.x === newX && segment.y === newY)
      ) {
        clearInterval(gameInterval);
        gameRunning = false;
        gameOverScreen.classList.remove("hidden");
        document.getElementById("currentScoreDisplay").textContent = `🎯 점수: ${score}`;
        updateHighScore(score);
        showRankingModal();
        return;
      }

      snake.unshift(newHead);
    }

    function updateHighScore(score) {
      fetch("/update_high_score", {
        method: "POST",
        body: JSON.stringify({ score }),
        headers: { "Content-Type": "application/json" }
      });
    }

    function showRankingModal() {
      fetch("/ranking")
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("rankingList");
          list.innerHTML = "";
          data.ranking.forEach((user, idx) => {
            const li = document.createElement("li");
            const crown = idx === 0 ? "👑 " : "";
            li.textContent = `${crown}${idx + 1}. ${user.username} - ${user.score}`;
            list.appendChild(li);
          });
          document.getElementById("rankingModal").classList.remove("hidden");
        });
    }

    function closeModal() {
      document.getElementById("rankingModal").classList.add("hidden");
    }

    document.addEventListener("keydown", changeDirection);
    startButton.addEventListener("click", startGame);
    restartButton.addEventListener("click", restartGame);
    restartGameOverButton.addEventListener("click", restartGame);
  </script>
</body>
</html>
