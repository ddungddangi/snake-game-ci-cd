<script>
  let gameInterval;
  
  function startGame() {
      if (gameRunning) return;
      gameRunning = true;
  
      startButton.classList.add("hidden");
      restartButton.classList.add("hidden");
      gameOverScreen.style.display = "none";
      canvas.style.display = "block";
      resetGame();
      fetchHighScore();
      gameInterval = setInterval(drawGame, 70);  // â© ì†ë„ ì¦ê°€
  }
  
  function drawGame() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
  
      ctx.fillStyle = "red";
      ctx.fillRect(food.x, food.y, box, box);
  
      ctx.fillStyle = "lime";
      snake.forEach(segment => ctx.fillRect(segment.x, segment.y, box, box));
  
      let newX = snake[0].x;
      let newY = snake[0].y;
  
      if (direction === "LEFT") newX -= box;
      if (direction === "RIGHT") newX += box;
      if (direction === "UP") newY -= box;
      if (direction === "DOWN") newY += box;
  
      if (newX === food.x && newY === food.y) {
          fetchFoodPosition();
          score += 10;
          currentScoreDisplay.textContent = score;
      } else {
          snake.pop();
      }
  
      const newHead = { x: newX, y: newY };
  
      if (newX < 0 || newX >= canvas.width || newY < 0 || newY >= canvas.height || collision(newHead, snake)) {
          clearInterval(gameInterval);
          gameRunning = false;
          gameOverScreen.style.display = "block";
          document.getElementById("currentScoreDisplay").textContent = `ðŸŽ¯ ì ìˆ˜: ${score}`;
  
          // ðŸ”½ ì ìˆ˜ ì—…ë°ì´íŠ¸ ë° ëž­í‚¹ ëª¨ë‹¬ ë°˜ì˜
          fetch("/update_high_score", {
              method: "POST",
              body: JSON.stringify({ score: score }),
              headers: { "Content-Type": "application/json" }
          }).then(() => {
              fetch("/ranking")
                  .then(res => res.json())
                  .then(data => {
                      const list = document.getElementById("ranking-list");
                      list.innerHTML = "";
                      data.ranking.forEach((user, idx) => {
                          const li = document.createElement("li");
                          const crown = idx === 0 ? "ðŸ‘‘ " : "";
                          li.textContent = `${crown}${idx + 1}. ${user.username} - ${user.score}`;
                          list.appendChild(li);
                      });
                      document.getElementById("rankingModal").style.display = "flex";
                  });
          });
  
          return;
      }
  
      snake.unshift(newHead);
  }
  </script>
  